name: Template Blue Green Deployment for Enterprise
on:
    workflow_call:
        inputs:
            SUBSCRIPTION_ID:
                required: true
                type: string
            ASA_SERVICE_NAME:
                required: true
                type: string
            ASA_RG:
                required: true
                type: string
            ASA_APP_NAME:
              required: true
              type: string
            REPOSITORY_PATH:
              required: true
              type: string
            SOURCE_PATH:
              required: true
              type: string
            DEPLOYMENT_ENVIRONMENT_SETTINGS:
              type: string
              default: ""
        secrets:
            AZURE_CREDENTIALS:
                required: true
jobs:
    deploy:
        runs-on: ubuntu-latest
        steps:
        - uses: actions/checkout@v3
          with:
            repository: ${{inputs.REPOSITORY_PATH}}
            path: to-deploy-folder
            ref: Azure
        - name: Set up Azure
          uses: azure/login@v1
          with:
            creds: ${{ secrets.AZURE_CREDENTIALS }}
        - name: Set up Azure Spring Extension
          run: |
            az extension add --name spring 
            az account set --subscription ${{ inputs.SUBSCRIPTION_ID }} 
            az configure --defaults group=${{ inputs.ASA_RG}} spring=${{inputs.ASA_SERVICE_NAME}} 
        - name: Lookup Staging Deployment Name
          run: |
            echo "STAGING_APP=$(az spring app deployment list --resource-group ${{ inputs.ASA_RG}} --service "${{inputs.ASA_SERVICE_NAME}}" --app ${{inputs.ASA_APP_NAME}} --query "[?properties.active==\`false\`].name" --output tsv)" >> $GITHUB_ENV
        - name: Deploy Cart service
          run: |
            az account set --subscription ${{ inputs.SUBSCRIPTION_ID }}
            az spring app deploy \
                --name ${{inputs.ASA_APP_NAME}} \
                --resource-group ${{ inputs.ASA_RG}} \
                --service "${{inputs.ASA_SERVICE_NAME}}" \
                --deployment $STAGING_APP \
                --env ${{inputs.DEPLOYMENT_ENVIRONMENT_SETTINGS}} \
                --source-path "${{ github.workspace }}${{inputs.SOURCE_PATH}}"
        - name: Test Staging Deployment
          run: |
            echo "Testing Staging Endpoint"
        - name: Active Staging Deployment
          run: |
            az spring app set-deployment \
                --name ${{inputs.ASA_SERVICE_NAME}} \
                --deployment $STAGING_APP 