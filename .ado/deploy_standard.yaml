# ADO Pipeline
name: Azure Springs Apps 

trigger: none

variables:
  - group: "Standard Deployment Configuration"
  - group: "Applications"
  - name: apiGatewayJar
    value: "spring-petclinic-api-gateway/target/spring-petclinic-api-gateway-3.0.1.jar"
  - name: adminServerJar
    value: "spring-petclinic-admin-server/target/spring-petclinic-admin-server-3.0.1.jar"
  - name: customersServiceJar
    value: "spring-petclinic-customers-service/target/spring-petclinic-customers-service-3.0.1.jar"
  - name: vetsServiceJar
    value: "spring-petclinic-vets-service/target/spring-petclinic-vets-service-3.0.1.jar" 
  - name: visitsServiceJar
    value: "spring-petclinic-visits-service/target/spring-petclinic-visits-service-3.0.1.jar" 

jobs:
  - job: deploy-hub-network
    pool: 
      vmImage: 'ubuntu-latest'

    steps:
      - checkout: self
      - task: ms-devlabs.custom-terraform-tasks.custom-terraform-installer-task.TerraformInstaller@1
        displayName: Install Terraform
      - task: AzureCLI@1
        displayName: Terraform credentials
        inputs:
          azureSubscription: ${{ parameters.TerraformEnvironmentServiceConnection }}
          scriptLocation: inlineScript
          inlineScript: |
            set -eu
            echo "##vso[task.setvariable variable=ARM_CLIENT_ID]$()"
            echo "##vso[task.setvariable variable=ARM_CLIENT_SECRET;issecret=true]$()"
            echo "##vso[task.setvariable variable=ARM_SUBSCRIPTION_ID]$(subscriptionId)"
            echo "##vso[task.setvariable variable=ARM_TENANT_ID]$(tenantId)"
          addSpnToEnvironment: true

      - task: AzureCLI@1
        displayName: Terraform init
        inputs:
          azureSubscription: ${{ parameters.TerraformBackendServiceConnection }}
          scriptLocation: inlineScript
          inlineScript: |
            set -eux  # fail on error
            terraform init \
              -backend-config=storage_account_name=$() \
              -backend-config=container_name=$() \
              -backend-config=key=$().tfstate \
              -backend-config=resource_group_name=$()
          workingDirectory: $()
          addSpnToEnvironment: true
      - task: AzureCLI@1
        displayName: Terraform plan
        inputs:
          azureSubscription: ${{ parameters.TerraformBackendServiceConnection }}
          scriptLocation: inlineScript
          inlineScript: |
            set -eux  # fail on error
            terraform plan -out my.plan \
              -var="state_sa_rg=$()" \
              -var="state_sa_name=$()" \
              -var="state_sa_container_name=$()" \
              -var="location=$()" \
              -var="name_prefix=$()" \
              -var="environment=$()" \
              -var="SPRINGAPPS_SPN_OBJECT_ID=$()"
          workingDirectory: $()
          addSpnToEnvironment: true

  - job: deploy-spoke-network
    pool: 
      vmImage: 'ubuntu-latest'

    steps:
      - checkout: self

  - job: deploy-shared-resources
    pool: 
      vmImage: 'ubuntu-latest'

    steps:
      - checkout: self

  - job: deploy-hub-firewall
    pool: 
      vmImage: 'ubuntu-latest'

    steps:
      - checkout: self

  - job: deploy-standard-sa
    pool: 
      vmImage: 'ubuntu-latest'

    steps:
      - checkout: self

  - job: deploy-pet-clinic-infra
    pool: 
      vmImage: 'ubuntu-latest'

    steps:
      - checkout: self

  - job: deploy-and-deploy-pet-clinic-ms
    pool: 
      vmImage: 'ubuntu-latest'

    steps:
      - checkout: self

  - job: destroy-pet-clinic-infra
    pool: 
      vmImage: 'ubuntu-latest'

    steps:
      - checkout: self

  - job: destroy-spoke-infra
    pool: 
      vmImage: 'ubuntu-latest'

    steps:
      - checkout: self

  - job: destroy-hub-firewall
    pool: 
      vmImage: 'ubuntu-latest'

    steps:
      - checkout: self

  - job: destroy-shared-resources
    pool: 
      vmImage: 'ubuntu-latest'

    steps:
      - checkout: self

  - job: destroy-spoke-network
    pool: 
      vmImage: 'ubuntu-latest'

    steps:
      - checkout: self

  - job: destroy-hub-network
    pool: 
      vmImage: 'ubuntu-latest'

    steps:
      - checkout: self